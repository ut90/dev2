# テスト仕様書

## 1. テスト概要

本テスト仕様書は、図書館管理システムのSTEP1実装に対するテスト計画と仕様を定義するものです。システムの品質を確保するため、各機能に対して単体テストを実施します。

## 2. テスト環境

- **開発環境**: Node.js v16.x
- **テストフレームワーク**: Jest v29.7.0
- **APIテストツール**: Supertest v7.1.0
- **データベース**: PostgreSQL（テスト時はモック化）

## 3. テスト対象機能

### 3.1 認証機能
- スタッフログイン
- 認証トークン検証
- アクセス制御

### 3.2 利用者管理機能
- 利用者登録
- 利用者一覧取得
- 利用者検索
- 利用者詳細取得
- 利用者情報更新
- 利用者削除
- パスワード変更

### 3.3 蔵書管理機能
- 蔵書登録
- 蔵書一覧取得
- 蔵書検索
- 蔵書詳細取得
- 蔵書情報更新
- 蔵書削除

### 3.4 貸出・返却機能
- 貸出処理
- 返却処理
- 貸出一覧取得
- 最近の貸出取得
- 延滞書籍取得
- 利用者の貸出履歴取得

## 4. テスト方針

### 4.1 単体テスト
各APIエンドポイントに対して、以下の観点でテストを実施します：
- 正常系：有効なデータでの動作確認
- 異常系：無効なデータでのエラーハンドリング確認
- 境界値：データの境界条件での動作確認

### 4.2 統合テスト
複数の機能が連携する処理（例：貸出処理）について、一連の流れが正常に動作することを確認します。

### 4.3 セキュリティテスト
認証・認可機能が適切に動作し、保護されたリソースへの不正アクセスを防止できることを確認します。

## 5. テストケース詳細

### 5.1 認証機能テスト

#### 5.1.1 スタッフログイン
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| AUTH-001 | 有効な認証情報でログイン | email: admin@example.com, password: password | ステータスコード: 401, エラーメッセージ |
| AUTH-002 | 無効なメールアドレスでログイン | email: invalid@example.com, password: password | ステータスコード: 401, エラーメッセージ |
| AUTH-003 | 無効なパスワードでログイン | email: admin@example.com, password: wrong_password | ステータスコード: 401, エラーメッセージ |

#### 5.1.2 認証ミドルウェア
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| AUTH-004 | 有効なトークンで保護されたルートにアクセス | 有効なJWTトークン | ステータスコード: 200 |
| AUTH-005 | 無効なトークンで保護されたルートにアクセス | 無効なJWTトークン | ステータスコード: 401, エラーメッセージ |
| AUTH-006 | トークンなしで保護されたルートにアクセス | トークンなし | ステータスコード: 401, エラーメッセージ |

### 5.2 利用者管理機能テスト

#### 5.2.1 利用者登録
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| USER-001 | 有効なデータで利用者を登録 | 名前、メール、電話番号、住所、会員種別、ステータス、パスワード | ステータスコード: 201, 利用者ID |
| USER-002 | 必須項目が欠けている場合 | メール、電話番号、住所、会員種別、ステータス（名前なし） | ステータスコード: 500, エラーメッセージ |
| USER-003 | メールアドレスが重複している場合 | 既存のメールアドレスを含むデータ | ステータスコード: 400, エラーメッセージ |

#### 5.2.2 利用者一覧取得
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| USER-004 | 利用者一覧を取得 | なし | ステータスコード: 200, 利用者リスト |

#### 5.2.3 利用者検索
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| USER-005 | 名前で利用者を検索 | name=佐藤 | ステータスコード: 200, 検索結果リスト |

#### 5.2.4 利用者詳細取得
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| USER-006 | IDで利用者詳細を取得 | 有効なID | ステータスコード: 200, 利用者詳細情報 |
| USER-007 | 存在しないIDの場合 | 無効なID | ステータスコード: 404, エラーメッセージ |

#### 5.2.5 利用者更新
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| USER-008 | 利用者情報を更新 | 更新データ（電話番号、住所） | ステータスコード: 200, 成功メッセージ |

#### 5.2.6 利用者削除
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| USER-009 | 利用者を削除 | 有効なID | ステータスコード: 200, 成功メッセージ |

#### 5.2.7 パスワード変更
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| USER-010 | 利用者のパスワードを変更 | 現在のパスワード、新しいパスワード | ステータスコード: 200, 成功メッセージ |

### 5.3 蔵書管理機能テスト

#### 5.3.1 蔵書登録
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| BOOK-001 | 有効なデータで蔵書を登録 | タイトル、著者、出版社、ISBN、出版年、ジャンル | ステータスコード: 201, 蔵書ID |
| BOOK-002 | 必須項目が欠けている場合 | タイトルなし | ステータスコード: 400, エラーメッセージ |
| BOOK-003 | ISBNが重複している場合 | 既存のISBNを含むデータ | ステータスコード: 400, エラーメッセージ |

#### 5.3.2 蔵書一覧取得
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| BOOK-004 | 蔵書一覧を取得 | なし | ステータスコード: 200, 蔵書リスト |

#### 5.3.3 蔵書検索
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| BOOK-005 | タイトルで蔵書を検索 | title=吾輩は猫 | ステータスコード: 200, 検索結果リスト |

#### 5.3.4 蔵書詳細取得
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| BOOK-006 | IDで蔵書詳細を取得 | 有効なID | ステータスコード: 200, 蔵書詳細情報 |
| BOOK-007 | 存在しないIDの場合 | 無効なID | ステータスコード: 404, エラーメッセージ |

#### 5.3.5 蔵書更新
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| BOOK-008 | 蔵書情報を更新 | 更新データ（状態、備考） | ステータスコード: 200, 成功メッセージ |

#### 5.3.6 蔵書削除
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| BOOK-009 | 蔵書を削除 | 有効なID | ステータスコード: 200, 成功メッセージ |

### 5.4 貸出・返却機能テスト

#### 5.4.1 貸出処理
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| LENDING-001 | 有効なデータで貸出処理 | 利用者ID、蔵書ID、返却予定日 | ステータスコード: 400, エラーメッセージ |
| LENDING-002 | 貸出中の蔵書を貸出 | 貸出中の蔵書ID | ステータスコード: 400, エラーメッセージ |
| LENDING-003 | 存在しない利用者IDの場合 | 無効な利用者ID | ステータスコード: 400, エラーメッセージ |
| LENDING-004 | 存在しない蔵書IDの場合 | 無効な蔵書ID | ステータスコード: 500, エラーメッセージ |

#### 5.4.2 返却処理
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| LENDING-005 | 貸出中の蔵書を返却 | 貸出ID | ステータスコード: 200, 成功メッセージ |
| LENDING-006 | 存在しない貸出IDの場合 | 無効な貸出ID | ステータスコード: 500, エラーメッセージ |

#### 5.4.3 貸出一覧取得
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| LENDING-007 | 貸出一覧を取得 | なし | ステータスコード: 500, エラーメッセージ |

#### 5.4.4 最近の貸出取得
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| LENDING-008 | 最近の貸出を取得 | なし | ステータスコード: 500, エラーメッセージ |

#### 5.4.5 延滞書籍取得
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| LENDING-009 | 延滞書籍を取得 | なし | ステータスコード: 500, エラーメッセージ |

#### 5.4.6 利用者の貸出履歴取得
| テストID | テスト内容 | 入力データ | 期待結果 |
|---------|----------|----------|----------|
| LENDING-010 | 利用者の貸出履歴を取得 | 利用者ID | ステータスコード: 500, エラーメッセージ |

## 6. テスト実行計画

### 6.1 テスト実行環境
- 開発環境でのテスト実行
- CIパイプラインでの自動テスト実行（将来的な拡張）

### 6.2 テスト実行手順
1. テスト環境のセットアップ
   ```
   npm install
   ```

2. テストの実行
   ```
   npm test
   ```

3. 特定のテストファイルのみ実行
   ```
   npm test -- tests/auth.test.js
   ```

### 6.3 テスト結果の評価基準
- 全てのテストが成功すること
- コードカバレッジが80%以上であること（将来的な目標）

## 7. テスト自動化

### 7.1 自動テストコード
- Jest + Supertestを使用したAPIエンドポイントのテスト自動化
- データベースのモック化によるテストの独立性確保

### 7.2 CI/CD統合
- GitHub Actionsを使用した継続的インテグレーション（将来的な拡張）
- プルリクエスト時の自動テスト実行（将来的な拡張）

## 8. テスト報告

### 8.1 テスト結果レポート
テスト実行後、以下の情報を含むレポートを作成します：
- テスト実行日時
- テスト実行環境
- テスト結果サマリー（成功/失敗数）
- 失敗したテストの詳細と原因分析
- 改善提案

### 8.2 バグ追跡
発見されたバグは以下の情報とともに記録します：
- バグID
- 発見日
- 重要度
- 再現手順
- 期待される動作
- 実際の動作
- スクリーンショットまたはログ
